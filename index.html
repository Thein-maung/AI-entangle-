<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entangle Chat-2 (PWA)</title>

  <!-- PWA manifest and theme -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00bcd4" />

  <!-- Styles (make sure filename is exactly style.css) -->
  <link rel="stylesheet" href="style.css" />

  <!-- QR & scanner libs are used by app.js (app.js expects jsQR and QRCode to be globally available) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>

  <!-- load app as module -->
  <script type="module" src="app.js" defer></script>
</head>
<body>
  <header style="text-align:center; padding:1rem 0; background:#0f2027; color:#00e5ff;">
    <h1 style="margin:0">ðŸ”— Entangle Chat-2</h1>
    <div style="font-size:0.9rem; opacity:0.85">Privacy-first PWA â€” QR pairing â€¢ Twin AI OTP â€¢ P2P voice</div>
  </header>

  <main style="max-width:780px; margin:1.2rem auto; padding:1rem;">
    <!-- Pairing -->
    <section id="pairing" class="card">
      <h2>1) Pair devices</h2>
      <div style="display:flex; gap:0.5rem; margin-bottom:0.6rem;">
        <input id="seed-input" placeholder="Optional passphrase (both must match)" style="flex:1; padding:0.6rem; border-radius:8px; border:1px solid #28343a;">
        <button id="make-qr">Generate QR</button>
        <button id="scan-btn" class="secondary">Scan Partner</button>
      </div>
      <div id="qrcode" style="margin:0.6rem 0"></div>
      <canvas id="qrcvs" hidden></canvas>
      <video id="cam" hidden playsinline style="width:100%; max-width:320px; border-radius:8px;"></video>
      <p class="system">Both phones must use the same seed/QR to derive identical keys.</p>
    </section>

    <!-- Chat -->
    <section id="text" class="card" style="margin-top:1rem;">
      <h2>2) Text Chat</h2>
      <div id="messages" style="height:240px; overflow:auto; background:#0b1113; padding:0.6rem; border-radius:8px;"></div>

      <div style="display:flex; gap:0.6rem; margin-top:0.8rem;">
        <textarea id="msg-input" rows="2" placeholder="Type a message..." style="flex:1; padding:0.6rem; border-radius:8px; border:1px solid #28343a"></textarea>
        <div style="width:120px; display:flex; flex-direction:column; gap:0.5rem;">
          <button id="send-txt">Encrypt & Send</button>
          <button id="decrypt-last" class="secondary">Decrypt Last</button>
        </div>
      </div>
      <p class="system" style="margin-top:0.6rem">Send ciphertext via the P2P datachannel (or copy to clipboard).</p>
    </section>

    <!-- WebRTC / Voice -->
    <section id="webrtc" class="card" style="margin-top:1rem;">
      <h2>3) P2P Connection & Voice</h2>

      <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.6rem;">
        <button id="create-offer">Create Offer (manual)</button>
        <button id="create-room-fb" class="secondary">Create Room (Firebase)</button>
        <button id="accept-offer">Accept Offer (manual)</button>
        <button id="join-room-fb" class="secondary">Join Room (Firebase)</button>
      </div>

      <textarea id="signaling" placeholder="Paste offer/answer or room id here" rows="5" style="width:100%; padding:0.6rem; border-radius:8px; border:1px solid #28343a;"></textarea>

      <div style="display:flex; gap:0.6rem; margin-top:0.8rem; align-items:center;">
        <button id="start-voice" disabled>Start Voice</button>
        <button id="hangup" class="secondary" disabled>Hang Up</button>
        <div id="status" style="margin-left:auto; font-style:italic">Status: <span id="statustxt">idle</span></div>
      </div>

      <audio id="remote-audio" autoplay playsinline style="width:100%; margin-top:0.6rem;"></audio>
      <p class="system" style="margin-top:0.6rem">Use Firebase buttons for automatic signaling (requires Realtime DB enabled).</p>
    </section>

    <!-- Debug -->
    <section id="debug" class="card" style="margin-top:1rem;">
      <h3>Debug / Entanglement</h3>
      <div>Entangled Hash: <span id="twin-hash">â€”</span></div>
      <div>OTP preview: <pre id="otp-preview" style="white-space:pre-wrap; margin:0">â€”</pre></div>
    </section>
  </main>

  <footer style="text-align:center; padding:0.8rem 0; color:#8892a6;">Entangle Chat-2 â€¢ demo</footer>

  <!-- Service Worker registration (app.js also may register) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(e => console.warn('SW registration failed:', e));
    }
  </script>
</body>
</html>
